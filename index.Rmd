---
title: "Considering the Ripple Effects of Climate Change"
author: "Bella Han, Lillian Kim, Mythili Subbanna"
date: "November 15, 2020"
runtime: shiny
output: 
  rmdformats::readthedown:
    thumbnails: false
    highlight: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")

library(tidyverse)
library(leaflet)
library(maps)
library(mdsr)
library(readr)
library(dplyr)
library(janitor)
library(countrycode)
library(tabulizer)
library(plotly)
library(ggplot2)
library(gganimate)
library(gifski)
library(shiny)
library(shinythemes)


path_mythili <- "C:/Users/seshu/Documents/RStudio/projects/git/Blog-HealthAndJusticeLeague/data"
path_bella <- "C:/Users/Bella/Desktop/git/Blog-HealthAndJusticeLeague/data"
path_lillian <- "C:/Users/Yesuel Kim/Documents/Git/Blog-HealthAndJusticeLeague/data"

######### fixme: change this before you run the code! ###########
my_path <- path_lillian

```

### Extra Info for insertion of elements into Blog - don't delete until the end!

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For example, you can include **Bold** and _Italic_ and `Code` text.  For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

You should test out updating your GitHub Pages website:

- clone your group's blog project repo in RStudio
- update "Your Project Title Here" to a new title in the YAML header
- knit `index.Rmd` 
- commit and push BOTH the `index.Rmd` and the `index.html` files
- go to https://stat231-f20.github.io/Blog-HealthAndJusticeLeague to see the published test document (this is publicly available!)


## Including links and images

You can include [Links](https://www.datadreaming.org/post/r-markdown-theme-gallery/) and images ![team logo](https://raw.githubusercontent.com/stat231-f20/Blog-HealthAndJusticeLeague/main/images/ph_sj1-7.png)

## Beyond Global Warming

According to the NASA Earth Observatory, climate change can affect the fuuture prevalence and intensity of various climate disasters. As seen in the plot below, there has been a global temp increase over time (1880-2020). This is partially due to the increase in greenhouse gas emission into the atmosphere. 

Unfortunately, subsequent effects of this temperature increase include a higher risk of droughts and possibly floods (since precipitation could fall less frequently, but in a higher amount). Furthermore, the temperature increase worldwide can homogenize the temperatures at the north and south poles, and the equator. The temperature increase will make the poles hotter and more humid, which in fact could reduce the number of storms. But this sounds like a good thing, right?

As land surface temperatures, humidity, and sea surface temperatures increase, there is more water vapor present in the atmosphere, so the intensity of the storms could increase. Furthermore, as is frequently said, rising temperatures are causing glacial melting, which increases the sea levels and thus increases the extent of coastal flooding.

Reference Used:
(https://earthobservatory.nasa.gov/features/RisingCost/rising_cost5.php)


```{r, warning = FALSE, message = FALSE, echo = FALSE}

gtemp <- read_csv(paste0(my_path, "/globaltemperature_all.csv")) %>%
  mutate(year = as.numeric(substr(period, 1,4)))


h <- ggplot(data = gtemp,
            aes(x = as.POSIXct(period, origin = "1970-01-01"), y = temp)) +
  geom_line(size = 0.2) +
  geom_hline(aes(yintercept = 0), color = "red", size = 0.2) +
  geom_smooth(alpha = 0.5, size = 1, linetype = 2) +
  theme(text = element_text(size = 15)) +
  labs(title = "Compared to 20th century average temperature") +
  scale_x_datetime(name = "Time") +
  scale_y_continuous(name = "Global temperature (celsius)")

shinyApp(

  ui = fluidPage(theme = shinytheme("cerulean"), 
                titlePanel("Change in Global Temperature"),
                fluidRow(
                  column(offset = 1, width = 11,
                         sliderInput(inputId = "tempYear",
                                     label = "Select the year",
                                     min = 1880,
                                     max = 2020,
                                     value = 2000,
                                     sep = "",
                                     ticks = TRUE,
                                     width = "90%"))
                ),
                fluidRow(
                  column(offset = 1, width = 11,
                         plotOutput("tempPlot", width = "90%", height = "400px")))
                ),

 server = function(input, output) {
  gtemp_react <- reactive({
    
    sample <- gtemp %>%
      filter(year == input$tempYear) %>%
      arrange(period)
    
    ## to highlight region data
    data.frame(start=sample[1,1],
               end=sample[nrow(sample), 1])
    
  })  
  
  output$tempPlot <- renderPlot({
    
    h +
      geom_rect(inherit.aes = FALSE,
                aes(xmin=as.POSIXct(gtemp_react()[1,1]), 
                    xmax=as.POSIXct(gtemp_react()[1,2]), 
                    ymin=-1.0, ymax=1.5), 
                fill="yellow", alpha=0.01)
    
  })
  
  },
  options = list(height = 500)
)

```

How does this relate to public health? We want to explore the ways in which climate disasters have ripple effects on different societies. In this blog we will focus on 3 different questions:

## Research Questions

1. Are the effects of climate change (specifically air pollution) evident in epidemiological prevalence data or mortality data?

2. What does the amount of homelessness and displacement due to climate disasters look like and how has that changed over time?

3. How do climate change ripple effects (measured via infant and maternal mortality) show differently in developing (i.e. more agriculture-based) versus developed countries?


# Tab 1: Bella's part

```{r, echo = FALSE, message = FALSE, warning = FALSE, include = FALSE}

path_PM25_guide <- 'https://apps.who.int/iris/bitstream/handle/10665/69477/WHO_SDE_PHE_OEH_06.02_eng.pdf;jsessionid=5F6D84FB5F54C304E800DCDDBC13E116?sequence=1'

#loading data
#ext_PM25_guide <- extract_tables(path_PM25_guide, output = "data.frame", row.names = NULL)
#PM25_guide <- ext_PM25_guide[[1]]
data_air <- read_csv(paste0(my_path, "/wrangled_air_final.csv."))
data_DALY <- read_csv(paste0(my_path, "/wrangled_DALY_final.csv."))
data_joined <- read_csv(paste0(my_path, "/joined_air_DALY_final.csv"))
```

```{r, message = FALSE, include = FALSE, warning = FALSE}
#leaflet for PM2.5
#world_leaflet$names
world_leaflet <- map("world", unique(data_air$Country), fill = TRUE, plot = FALSE)
world_leaflet$country <- vapply(strsplit(world_leaflet$names, ":"), function(x) x[1],
                                FUN.VALUE = "a")
world_leaflet$Y1990 <- data_air$Y1990[match(world_leaflet$country, data_air$Country)]
world_leaflet$Y2017 <- data_air$Y2017[match(world_leaflet$country, data_air$Country)]
world_leaflet$change <- data_air$change[match(world_leaflet$country, data_air$Country)]

bins <- c(0, 10, 15, 25, 35, Inf)
binschange <- c(-Inf, -5, 0, 5, Inf)
pal1990 <- colorBin("YlOrRd", domain = world_leaflet$Y1990, bins = bins)
pal2017 <- colorBin("YlOrRd", domain = world_leaflet$Y2017, bins = bins)
palchange <- colorBin("PiYG", domain = world_leaflet$change, bins = binschange)

#for 1990
PM25_1990_leaflet <- leaflet(data = world_leaflet)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~pal1990(Y1990),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g µg / m<sup>3</sup>",
                              world_leaflet$country, world_leaflet$Y1990)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet$country, "<br>",
                             "PM2.5 Value: ", round(world_leaflet$Y1990, 3), 
                             " µg / m<sup>3</sup><br>"))%>%
  addLegend(pal = pal1990, values = ~Y1990, 
            opacity = 0.7, 
            title = "PM 2.5 Measure in 1990",
            position = "bottomright")


#for 2017
PM25_2017_leaflet <- leaflet(data = world_leaflet)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~pal2017(Y2017),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g µg / m<sup>3</sup>",
                              world_leaflet$country, world_leaflet$Y2017)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet$country, "<br>",
                             "PM2.5 Value: ", round(world_leaflet$Y2017, 3), 
                             " µg / m<sup>3</sup><br>"))%>%
  addLegend(pal = pal2017, values = ~Y2017, 
            opacity = 0.7, 
            title = "PM 2.5 Measure in 2017",
            position = "bottomright")

PM25_change_leaflet <- leaflet(data = world_leaflet)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~palchange(change),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g µg / m<sup>3</sup>",
                              world_leaflet$country, world_leaflet$change)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet$country, "<br>",
                             "PM2.5 Value: ", round(world_leaflet$change, 3), 
                             " µg / m<sup>3</sup><br>"))%>%
  addLegend(pal = palchange, values = ~change, 
            opacity = 0.7, 
            title = "Chagne in PM 2.5 Meausre from 1990 to 2017",
            position = "bottomright")
```

```{r, echo = FALSE}
#PM2.5 leaflets
PM25_1990_leaflet
PM25_2017_leaflet
PM25_change_leaflet
```

```{r, include = FALSE, warning = FALSE}
#leaflet for pdeaths
world_leaflet_DALY <- map("world", unique(data_DALY$country), 
                            fill = TRUE, plot = FALSE)
world_leaflet_DALY$country <- vapply(strsplit(world_leaflet_DALY$names, ":"),
                                       function(x) x[1],
                                FUN.VALUE = "a")
world_leaflet_DALY$Y1990 <- data_DALY$Y1990[match(world_leaflet_DALY$country, data_DALY$country)]
world_leaflet_DALY$Y2017 <- data_DALY$Y2017[match(world_leaflet_DALY$country, data_DALY$country)]
world_leaflet_DALY$change <- data_DALY$change[match(world_leaflet_DALY$country, data_DALY$country)]

binschange2 <- c(-Inf, -5, 0, 5, Inf)
bins2 <- c(0, 5, 10, 15, 20, Inf)
pal1990_2 <- colorBin("YlGnBu", domain = world_leaflet_DALY$Y1990, bins = bins2)
pal2017_2 <- colorBin("YlGnBu", domain = world_leaflet_DALY$Y2017, bins = bins2)
palchange2 <- colorBin("PiYG", domain = world_leaflet_DALY$change, bins = binschange2)

#for 1990
DALY_1990_leaflet <- leaflet(data = world_leaflet_DALY)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~pal1990_2(Y1990),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g units",
                              world_leaflet_DALY$country, world_leaflet_DALY$Y1990)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal",
                                                       padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet_DALY$country, "<br>",
                             "DALY",
                             round(world_leaflet_DALY$Y1990, 2), 
                             " per 1k <br>"))%>%
  addLegend(pal = pal1990_2, values = ~Y1990, 
            opacity = 0.7, 
            title = "DALY in 1990",
            position = "bottomright")

#for 2017
DALY_2017_leaflet <- leaflet(data = world_leaflet_DALY)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~pal2017_2(Y2017),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g units",
                              world_leaflet_DALY$country, world_leaflet_DALY$Y2017)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal",
                                                       padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet_DALY$country, "<br>",
                             "DALY Score: ",
                             round(world_leaflet_DALY$Y2017, 3), 
                             " per 1K <br>"))%>%
  addLegend(pal = pal2017_2, values = ~Y2017, 
            opacity = 0.7, 
            title = "DALY scores in 2017",
            position = "bottomright")

#CHANGE from 1990 to 2017
DALY_change_leaflet <- leaflet(data = world_leaflet_DALY)%>%
  addTiles()%>%
  setView(0, 0, zoom = 1.5)%>%
  addPolygons(fillColor = ~palchange2(change),
              weight = 1,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(weight = 2,
                                           color = "#666",
                                           dashArray = "",
                                           fillOpacity = 0.7,
                                            bringToFront = TRUE),
              label = sprintf("<strong>%s</strong><br/>%g units",
                              world_leaflet_DALY$country, world_leaflet_DALY$change)%>% 
                lapply(htmltools::HTML),
              labelOptions = labelOptions(style = list("font-weight" = "normal",
                                                       padding = "3px 8px"),
                                          textsize = "12px",
                                          direction = "auto"),
              popup = paste0("Country: ", world_leaflet_DALY$country, "<br>",
                             "DALY Score: ",
                             round(world_leaflet_DALY$change, 3), 
                             " per 1K <br>")) %>%
   addLegend(pal = palchange2, values = ~change, 
            opacity = 0.7, 
             title = "Change in DALY scores",
             position = "bottomright")
```

```{r, echo = FALSE}
DALY_1990_leaflet
DALY_2017_leaflet
DALY_change_leaflet
```

```{r, message = FALSE, warning = FALSE, include = FALSE}
#is there a way to look at how both variables change in relation to one another over time,
#in a more broader term and in a single visualization?

g <- ggplot(data_joined, aes(PM25exposure , DALY, color = country))+
  geom_point(alpha = 0.7, show.legend = FALSE)+
  scale_size(range = c(2, 12))+
  theme_classic()+
  labs(title = 'Year: {round(frame_time, 0)}', x = 'PM 2.5', y = 'DALY per 1K')+
  transition_time(year)+
  ease_aes('linear')
```

```{r, echo = FALSE, message = FALSE}
animate(g, duration = 20, fps = 20, width = 400, height = 400, renderer = gifski_renderer())
#anim_save("PM2.5 vs. DALY.gif")
```

```{r, message = FALSE, warning = FALSE, include = FALSE}
countrylist_index <- floor(runif(10, min = 0, max = nrow(data_joined)))
countrylist <- rep(c("country"), 10)

for (i in 1:length(countrylist_index)){
  countrylist[i] <- data_joined$country[countrylist_index[i]]
}

data_joined <- subset(data_joined, country %in% countrylist)


gdaly <- ggplotly(ggplot(data = data_joined, mapping = aes(x = year, y = DALY, color = country)) +
    geom_line() +
  scale_y_continuous(trans = "log10")+
    labs(
      title = "Disability-Adjusted Life (DALY) Year per 1K",
      subtitle = "1990 to 2017",
      y = "DALY",
      x = "Year")+
    theme_classic())

gexposure <- ggplotly(ggplot(data = data_joined, mapping = aes(x = year, y = PM25exposure, color = country)) +
     geom_line() +
     labs(
       title = "Population exposure to PM 2.5",
       subtitle = "1990 to 2017",
       y = "Population exposure ",
       x = "Year")+
    theme_classic())
```

```{r, echo = FALSE}
gdaly
gexposure
```

# Tab 2: Mythili's part

```{r, warning = FALSE, message = FALSE, echo = FALSE}

## 1980s Cluster

#loading data
data_cluster1980s <- read_csv(paste0(my_path,"/wrangled_infmatmortcluster1980s.csv")) %>%
  mutate_at(c("avginfmort", "avmatmort"), funs(`std`=scale(.) %>% as.vector()))

#making cluster reproducible, setting number of clusters
set.seed(23)
km_out <- kmeans(data_cluster1980s[,c("avginfmort_std", "avmatmort_std")], centers = 3, nstart=20)

#vector of cluster assignments
km_out$cluster

# add cluster assignment to the data frame
cluster1980s <- data_cluster1980s %>%
  mutate(clust = as.character(km_out$cluster))

# visualize the cluster assignments and centroids
ggplot(data = cluster1980s, aes(x = avginfmort_std, y = avmatmort_std)) + 
  geom_point(aes(color = clust)) +
  coord_fixed() +
  geom_point(data = as.data.frame(km_out$centers)
             , aes(x = avginfmort_std, y = avmatmort_std)
             , pch = "X"
             , size = 4) +
  labs(x = "Standardized Average Infant Mortality in 1980s"
       , y = "Standardized Average Maternal Mortality in 1980s" 
       , color = "Cluster Assignment")

```

```{r, warning = FALSE, echo = FALSE}

## 2010s Cluster

#loading data
data_cluster2010s <- read_csv(paste0(my_path, "/wrangled_infmatmortcluster2010s.csv")) %>%
  mutate_at(c("avginfmort", "avmatmort"), funs(`std`=scale(.) %>% as.vector()))

#making cluster reproducible, setting number of clusters
set.seed(23)
km_out <- kmeans(data_cluster2010s[,c("avginfmort_std", "avmatmort_std")], centers = 3, nstart=20)

#vector of cluster assignments
km_out$cluster

# add cluster assignment to the data frame
cluster2010s <- data_cluster2010s %>%
  mutate(clust2 = as.character(km_out$cluster))

# visualize the cluster assignments and centroids
ggplot(data = cluster2010s, aes(x = avginfmort_std, y = avmatmort_std)) + 
  geom_point(aes(color = clust2)) +
  coord_fixed() +
  geom_point(data = as.data.frame(km_out$centers)
             , aes(x = avginfmort_std, y = avmatmort_std)
             , pch = "X"
             , size = 4) +
  labs(x = "Standardized Average Infant Mortality in 2010s"
       , y = "Standardized Average Maternal Mortality in 2010s" 
       , color = "Cluster Assignment")

```


# Tab 3: Lillian's part

Here, I am investigating how the impacts of natural disasters have changed over time since 1980 until 2020. Specifically, how has the frequency of natural disasters changed? How has the number of people killed, injured, affected, and displaced due to these disasters changed?  
To investigate this problem, we obtained a dataset that recorded "impactful" natural disasters for the past 40 years. By "impactful" we mean that these disasters killed, injured, displaced, or affected humans in various ways. Take a look at the shiny app below.

```{r, message = FALSE, warning = FALSE, echo = FALSE}
# calling in the datasets

# natural disaster dataset
natdis <- read_csv(paste0(my_path, "/wrangled_natdisasters_byyear.csv")) %>%
  filter(disaster_type != "All")
#explicitly call maps:: because map() is masked by purrr packagef
natdis_leaflet <- maps::map("world", fill = TRUE, plot = FALSE, wrap=c(-180,180)) 
# This is the dataset containing 
# the official country code, official country name, 
# and country name used in maps package
data(iso3166)

# a3 is iso3c country code
list_countries <- iso3166 %>%
  select(a3, ISOname, mapname)

# HTML Text: background info to display on the side
text <- sprintf("<strong>%s</strong>%s<br/><br/>%s<br/>%s<br/>%s<br/>%s<br/>%s<br/><br/>",
                "Source: EM-DAT",
                a(href="https://www.emdat.be/", " (The International Disaster Database)"),
                "This app only shows the natural disasters that fulfill the following criteria:",
                "a) 10 or more reported killed; or",
                "b) 100 or more reported affected; or",
                "c) A state of emergency declared; or",
                "d) International assistance requested")%>% 
  lapply(htmltools::HTML)

# for checkboxGroupInput choices
relevant <- unique(natdis$disaster_type)
```


```{r, warning = FALSE, message = FALSE, echo=FALSE}
shinyApp(

  ui = fluidPage(theme = shinytheme("cerulean"), 
  titlePanel("Impacts of Natural Disasters"),
  # Instead of sidebar, change the layout?
  fluidRow(
    column(width = 6, style = "padding: 20px",
      # disaster type
      checkboxGroupInput(inputId = "disaster",
                         label = "Select disaster(s)",
                         choices = relevant,
                         selected = relevant,
                         inline = TRUE)),
    column(width = 6,
      # year
      sliderInput(inputId = "year",
                  label = "Select the year",
                  min = 1980,
                  max = 2020,
                  value = 2000,
                  sep = "",
                  ticks = TRUE,
                  width = "90%"))),
    fluidRow(
      column(width = 5,
            text
            ),
      column(width = 7,
           leafletOutput("natdisplot"))
  )
),

  server = function(input, output) {
    # natural disasters of a given type in a given year
  natdis_react <- reactive({
    natdis %>%
      filter(disaster_type %in% input$disaster) %>%
      filter(year == input$year) %>%
      # Below operation is because the country names used in maps package and 
      # the country names in natdis data differ
      right_join(list_countries, by = c("countrycode" = "a3"))
    
  })
  
  
  a <- reactive({
    # country name
    natdis_leaflet$country <- str_extract(natdis_leaflet$names, "[^:]+")
    
    # how many disasters occurred in a given year?
    # Use mapname to fill in the corresponding values in the freq vector
    natdis_leaflet$freq <- natdis_react()$occurrence[match(natdis_leaflet$country,
                                                           natdis_react()$mapname)]
    
    natdis_leaflet$deaths <- natdis_react()$deaths[match(natdis_leaflet$country,
                                                         natdis_react()$mapname)]
    
    
    natdis_leaflet$injured <- natdis_react()$injured[match(natdis_leaflet$country,
                                                           natdis_react()$mapname)]
    
    
    natdis_leaflet$homeless <- natdis_react()$homeless[match(natdis_leaflet$country,
                                                             natdis_react()$mapname)]
    
    
    natdis_leaflet$affected <- natdis_react()$affected[match(natdis_leaflet$country,
                                                             natdis_react()$mapname)]
    
    # deaths + injured + homeless + affected
    natdis_leaflet$total <- natdis_react()$total[match(natdis_leaflet$country,
                                                       natdis_react()$mapname)]
    
    natdis_leaflet
  })
  
  bins <- c(0, 1000, 5000, 10000, 50000, 100000, 500000, 1000000, 5000000, Inf)
  pal_natdis <- reactive({
    colorBin("YlOrRd", domain = a()$total, bins = bins)
  })
  
  
  output$natdisplot <- renderLeaflet({
    # Use leaflet() here, and only include aspects of the map that
    # won't need to change dynamically (at least, not unless the
    # entire map is being torn down and recreated).
    leaflet(data = a()) %>%
      addTiles() %>%
      setView(80, 0, zoom = 1)
      
  })
  
  # separating it into observe section reduces the delay/lag 
  # when variable selection changes because the background map is not being
  # drawn all over again!
  observe({
    
    leafletProxy("natdisplot", data = a()) %>%
      # reference: https://stackoverflow.com/questions/48953149/dynamic-color-fill-for-polygon-using-leaflet-in-shiny-not-working
      addPolygons(fillColor = ~pal_natdis()(total),
                  weight = 2,
                  opacity = 1,
                  color = "white",
                  dashArray = "3",
                  fillOpacity = 0.5,
                  popup = paste0("region: ", a()$country, "<br>",
                                 "occurred: ", a()$freq, " time(s)", "<br>",
                                 "deaths: ", a()$deaths, "<br>", 
                                 "injured: ", a()$injured, "<br>",
                                 "affected: ", a()$affected, "<br>",
                                 "homeless: ", a()$homeless, "<br>"),
                  highlight = highlightOptions(
                    weight = 5,
                    color = "#666",
                    dashArray = "",
                    fillOpacity = 0.7,
                    bringToFront = TRUE)) %>%
    addLegend(pal = pal_natdis(), values = ~total, opacity = 0.7, title = NULL,
              position = "bottomright")
    
    
  })
  },

  options = list(height = 500)
)
```


